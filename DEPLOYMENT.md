# Mythofy Mail - Deployment Guide

## 🚀 Quick Start (Dedicated Server)

### One-Command Setup

```bash
# Clone or transfer the project to your server
cd /opt
git clone <your-repo> mythofy-mail
cd mythofy-mail

# Run setup (installs Docker, creates .env, pulls images)
chmod +x setup.sh
./setup.sh

# Edit .env with your Mailcow credentials
nano .env

# Deploy!
./deploy.sh
```

**That's it!** The app will be running at:
- Frontend: http://localhost:3000
- Backend: http://localhost:8080
- Nginx: http://localhost (or your domain)

---

## 📋 Detailed Setup

### 1. Prerequisites

Your server should have:
- Ubuntu 20.04+ or Debian 11+ (or any Linux with Docker support)
- 2GB+ RAM
- 10GB+ disk space
- Access to your Mailcow instance

### 2. Initial Setup

```bash
# Make scripts executable
chmod +x setup.sh deploy.sh

# Run setup script (only needed once)
./setup.sh
```

This will:
- ✅ Install Docker & Docker Compose
- ✅ Create `.env` from template
- ✅ Generate JWT secret
- ✅ Create required directories
- ✅ Pull base Docker images

### 3. Configure Environment

Edit `.env`:

```bash
nano .env
```

**Required settings:**
```env
# Your Mailcow API key (get from Mailcow admin panel)
MAILCOW_API_KEY=your-actual-api-key-here

# Your Mailcow server
MAILCOW_API_URL=https://mail.mythofy.net
IMAP_HOST=mail.mythofy.net
SMTP_HOST=mail.mythofy.net

# JWT secret (auto-generated by setup.sh)
JWT_SECRET=<auto-generated>
```

### 4. Deploy

```bash
# Deploy all services
./deploy.sh

# Or deploy in production mode
./deploy.sh prod
```

The script will:
- ✅ Build Docker images
- ✅ Start all containers
- ✅ Check health status
- ✅ Show you service URLs

---

## 🐳 Docker Commands

### View Logs
```bash
# All services
docker-compose logs -f

# Specific service
docker-compose logs -f backend
docker-compose logs -f frontend
```

### Restart Services
```bash
# Restart all
docker-compose restart

# Restart specific service
docker-compose restart backend
```

### Stop & Start
```bash
# Stop all
docker-compose down

# Start all
docker-compose up -d

# Rebuild and start
docker-compose up -d --build
```

### Check Status
```bash
# View running containers
docker-compose ps

# Check health
docker-compose ps | grep healthy
```

---

## 🔧 Development Mode

For development on the server with hot reload:

### Frontend (Next.js)
```bash
cd frontend
npm install
npm run dev
# Runs on http://localhost:3000
```

### Backend (Rust)
```bash
cd backend
cargo run
# Runs on http://localhost:8080
```

### Frontend + Backend (Docker)
```bash
# Use docker-compose for development
docker-compose up frontend backend
```

---

## 📁 Directory Structure

```
mythofy-mail/
├── frontend/              # Next.js application
│   ├── src/
│   ├── Dockerfile
│   └── package.json
├── backend/               # Rust API
│   ├── src/
│   ├── Dockerfile
│   └── Cargo.toml
├── nginx/                 # Reverse proxy config
│   ├── nginx.conf
│   └── ssl/              # SSL certificates go here
├── docker-compose.yml    # Container orchestration
├── .env                  # Environment variables
├── setup.sh              # Initial setup script
└── deploy.sh             # Deployment script
```

---

## 🔐 SSL/TLS Setup

### Option 1: Let's Encrypt (Recommended)

```bash
# Install certbot
sudo apt install certbot

# Generate certificate
sudo certbot certonly --standalone -d mail.mythofy.net

# Copy to nginx directory
sudo cp /etc/letsencrypt/live/mail.mythofy.net/fullchain.pem nginx/ssl/cert.pem
sudo cp /etc/letsencrypt/live/mail.mythofy.net/privkey.pem nginx/ssl/key.pem
sudo chmod 644 nginx/ssl/*.pem

# Restart nginx
docker-compose restart nginx
```

### Option 2: Self-Signed (Development)

```bash
# Generate self-signed certificate
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout nginx/ssl/key.pem \
  -out nginx/ssl/cert.pem \
  -subj "/CN=mail.mythofy.net"

# Restart nginx
docker-compose restart nginx
```

---

## 🔄 Updates & Rebuilds

### Pull Latest Changes
```bash
git pull
```

### Rebuild Specific Service
```bash
# Rebuild frontend
docker-compose build frontend
docker-compose up -d frontend

# Rebuild backend
docker-compose build backend
docker-compose up -d backend
```

### Full Rebuild
```bash
docker-compose down
docker-compose build --no-cache
docker-compose up -d
```

---

## 🗄️ Database Management

### Backup Database
```bash
# Backup MySQL
docker-compose exec mysql mysqldump -u mailuser -pmailpass mythofy_mail > backup.sql

# Backup Redis
docker-compose exec redis redis-cli SAVE
docker cp mythofy-mail-redis:/data/dump.rdb redis-backup.rdb
```

### Restore Database
```bash
# Restore MySQL
docker-compose exec -T mysql mysql -u mailuser -pmailpass mythofy_mail < backup.sql
```

### Reset Database
```bash
# WARNING: This deletes all data!
docker-compose down -v
docker-compose up -d mysql
sleep 30  # Wait for MySQL to initialize
docker-compose up -d
```

---

## 🐛 Troubleshooting

### Service Won't Start

**Check logs:**
```bash
docker-compose logs backend
```

**Common issues:**
- Missing environment variables in `.env`
- Port already in use
- Insufficient permissions

### Database Connection Failed

```bash
# Check MySQL is healthy
docker-compose ps mysql

# Restart MySQL
docker-compose restart mysql

# Wait 30 seconds and try again
```

### Frontend Build Fails

```bash
# Clear Next.js cache
cd frontend
rm -rf .next node_modules
npm install
cd ..

# Rebuild
docker-compose build frontend
```

### Backend Won't Compile

```bash
# Clear Rust cache
cd backend
cargo clean
cd ..

# Rebuild
docker-compose build backend
```

---

## 🌐 Production Deployment

### DNS Configuration
Point your domain to the server:
```
A record: mail.mythofy.net → <server-ip>
```

### Firewall
```bash
# Allow HTTP/HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable
```

### Update nginx.conf
```bash
nano nginx/nginx.conf
```

Change `server_name`:
```nginx
server_name mail.mythofy.net;
```

### Environment Variables
```bash
nano .env
```

Update frontend URL:
```env
NEXT_PUBLIC_API_URL=https://mail.mythofy.net
```

### Deploy
```bash
./deploy.sh prod
```

---

## 📊 Monitoring

### View Resource Usage
```bash
docker stats
```

### Check Health
```bash
# All services
docker-compose ps

# Specific health check
docker inspect mythofy-mail-backend | grep -A 10 Health
```

### Monitor Logs
```bash
# Follow all logs
docker-compose logs -f

# Only errors
docker-compose logs | grep -i error
```

---

## 🔄 Continuous Development (Claude Code)

For Claude Code to continue building:

### 1. Clone on Dedi Server
```bash
cd /opt
git clone <repo> mythofy-mail
cd mythofy-mail
```

### 2. Install Claude Code Dependencies
```bash
# For frontend development
cd frontend
npm install

# For backend development
cd ../backend
cargo build
```

### 3. Development Workflow

**Option A: Direct development**
```bash
# Frontend
cd frontend && npm run dev

# Backend
cd backend && cargo run
```

**Option B: Docker with hot reload**
```bash
# Mount code as volume in docker-compose
docker-compose up -d
```

### 4. Make Changes

Claude Code can now:
- Edit files directly
- Run `./deploy.sh` to test changes
- Commit and push updates
- No need to rebuild Docker images for dev

---

## 📚 Additional Resources

- [README.md](README.md) - Overview and features
- [SETUP.md](SETUP.md) - Detailed setup guide
- [HTML-AND-AVATAR-FEATURES.md](HTML-AND-AVATAR-FEATURES.md) - Avatar & HTML features
- [Docker Docs](https://docs.docker.com/)
- [Next.js Docs](https://nextjs.org/docs)
- [Rust Axum Docs](https://docs.rs/axum)

---

## 🆘 Support

Issues? Check:
1. Logs: `docker-compose logs`
2. Health: `docker-compose ps`
3. Environment: `cat .env`
4. Ports: `netstat -tulpn | grep -E '3000|8080|80|443'`

---

**Mythofy Mail** - Easy deployment, powerful features! 🚀
